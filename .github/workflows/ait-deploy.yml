name: Flutter AIT Build & Deploy

on:
  push:
    branches: ["main"]
  workflow_dispatch:
    inputs:
      deploy:
        description: "Run AIT deploy step (requires TOSS_KEY)"
        required: false
        default: true
        type: boolean

permissions:
  contents: read

concurrency:
  group: flutter-ait-deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-deploy-ait:
    runs-on: ubuntu-latest
    timeout-minutes: 40

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Flutter pub get
        working-directory: flutter
        run: flutter pub get

      - name: Flutter analyze
        working-directory: flutter
        run: flutter analyze

      - name: Flutter test
        working-directory: flutter
        run: flutter test

      - name: Build Flutter web release
        working-directory: flutter
        run: flutter build web --release

      - name: Sync Flutter web bundle to Vite public
        run: |
          rm -rf public/flutter
          mkdir -p public/flutter
          cp -R flutter/build/web/. public/flutter/

      - name: Install web dependencies
        run: npm ci

      - name: Build AIT bundle (Vite + ait)
        env:
          VITE_DEBUG_AUTH_FLOW: "true"
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: takealook-artifacts
          path: |
            takealook.ait
            flutter/build/web

      - name: Evaluate deploy availability
        id: gate
        env:
          TOSS_KEY: ${{ secrets.TOSS_KEY }}
        run: |
          SHOULD_DEPLOY="true"

          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ inputs.deploy }}" != "true" ]; then
            SHOULD_DEPLOY="false"
          fi

          if [ -z "$TOSS_KEY" ]; then
            SHOULD_DEPLOY="false"
            echo "reason=TOSS_KEY secret missing" >> "$GITHUB_OUTPUT"
          else
            echo "reason=ready" >> "$GITHUB_OUTPUT"
          fi

          echo "should_deploy=$SHOULD_DEPLOY" >> "$GITHUB_OUTPUT"

      - name: Deploy to Apps in Toss
        id: deploy
        if: steps.gate.outputs.should_deploy == 'true'
        env:
          TOSS_KEY: ${{ secrets.TOSS_KEY }}
        run: |
          set -eo pipefail
          npx ait deploy --api-key "$TOSS_KEY" | tee deploy.log

          SCHEME=$(grep -Eo 'intoss-private://[^[:space:]]+' deploy.log | tail -n 1 | sed -E 's/\x1B\[[0-9;]*[mK]//g' || true)
          if [ -z "$SCHEME" ]; then
            echo "Failed to extract intoss-private scheme from deploy output"
            cat deploy.log
            exit 1
          fi

          echo "scheme=$SCHEME" >> "$GITHUB_OUTPUT"

      - name: Build QR URL and PNG
        id: qr
        if: steps.gate.outputs.should_deploy == 'true'
        run: |
          SCHEME='${{ steps.deploy.outputs.scheme }}'
          ENCODED=$(node -e "console.log(encodeURIComponent(process.argv[1]))" "$SCHEME")
          QR_URL="https://quickchart.io/qr?size=420&text=${ENCODED}"
          echo "qr_url=$QR_URL" >> "$GITHUB_OUTPUT"
          curl -fsSL "$QR_URL" -o takealook-deploy-qr.png

      - name: Upload QR artifact
        if: steps.gate.outputs.should_deploy == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: takealook-deploy-qr
          path: takealook-deploy-qr.png

      - name: Write workflow summary (deployed)
        if: steps.gate.outputs.should_deploy == 'true' && success()
        run: |
          {
            echo "## ✅ Flutter 기반 AIT 배포 완료"
            echo ""
            echo "- CI chain: pub get → analyze → test → build web"
            echo "- AIT bundle: \\`takealook.ait\\`"
            echo "- Flutter web artifact: \\`flutter/build/web\\`"
            echo "- Scheme: \\`${{ steps.deploy.outputs.scheme }}\\`"
            echo "- QR URL: ${{ steps.qr.outputs.qr_url }}"
            echo ""
            echo "![Deploy QR](${{ steps.qr.outputs.qr_url }})"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Write workflow summary (skipped)
        if: steps.gate.outputs.should_deploy != 'true'
        run: |
          {
            echo "## ℹ️ AIT deploy skipped"
            echo ""
            echo "- reason: ${{ steps.gate.outputs.reason }}"
            echo "- CI chain and artifact upload were completed"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Notify Discord (success)
        if: steps.gate.outputs.should_deploy == 'true' && success()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -z "$DISCORD_WEBHOOK_URL" ]; then
            echo "DISCORD_WEBHOOK_URL not set. Skip Discord notification."
            exit 0
          fi

          MSG="✅ Flutter AIT 배포 완료\n- scheme: ${{ steps.deploy.outputs.scheme }}\n- qr: ${{ steps.qr.outputs.qr_url }}\n- run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          export MSG
          PAYLOAD=$(python3 - <<'PY'
import json, os
print(json.dumps({"username":"떼껄룩봇","content":os.environ["MSG"]}, ensure_ascii=False))
PY
)
          curl -sS -X POST "$DISCORD_WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d "$PAYLOAD"

      - name: Notify Discord (failure)
        if: failure()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -z "$DISCORD_WEBHOOK_URL" ]; then
            echo "DISCORD_WEBHOOK_URL not set. Skip Discord notification."
            exit 0
          fi

          MSG="❌ Flutter AIT 배포 실패\n- job: ${{ github.job }}\n- run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\n- 원인 확인: failed step logs"
          export MSG
          PAYLOAD=$(python3 - <<'PY'
import json, os
print(json.dumps({"username":"떼껄룩봇","content":os.environ["MSG"]}, ensure_ascii=False))
PY
)
          curl -sS -X POST "$DISCORD_WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d "$PAYLOAD"
