name: Web FE AIT Build & Deploy

on:
  push:
    branches: ["main"]
  workflow_dispatch:
    inputs:
      deploy:
        description: "Run AIT deploy step (requires TOSS_KEY)"
        required: false
        default: true
        type: boolean

permissions:
  contents: read

concurrency:
  group: web-ait-deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-deploy-ait:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Build AIT bundle (Web FE)
        env:
          VITE_DEBUG_AUTH_FLOW: "true"
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: web-fe-artifacts
          path: |
            takealook.ait
            dist

      - name: Evaluate deploy availability
        id: gate
        env:
          TOSS_KEY: ${{ secrets.TOSS_KEY }}
        run: |
          SHOULD_DEPLOY="true"

          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ github.event.inputs.deploy || 'true' }}" != "true" ]; then
            SHOULD_DEPLOY="false"
          fi

          if [ -z "$TOSS_KEY" ]; then
            SHOULD_DEPLOY="false"
            echo "reason=TOSS_KEY secret missing" >> "$GITHUB_OUTPUT"
          else
            echo "reason=ready" >> "$GITHUB_OUTPUT"
          fi

          echo "should_deploy=$SHOULD_DEPLOY" >> "$GITHUB_OUTPUT"

      - name: Deploy to Apps in Toss
        id: deploy
        if: steps.gate.outputs.should_deploy == 'true'
        env:
          TOSS_KEY: ${{ secrets.TOSS_KEY }}
        run: |
          set -eo pipefail
          npx ait deploy --api-key "$TOSS_KEY" | tee deploy.log

          SCHEME=$(grep -Eo 'intoss-private://[^[:space:]]+' deploy.log | tail -n 1 | sed -E 's/\x1B\[[0-9;]*[mK]//g' || true)
          if [ -z "$SCHEME" ]; then
            echo "Failed to extract intoss-private scheme from deploy output"
            cat deploy.log
            exit 1
          fi

          echo "scheme=$SCHEME" >> "$GITHUB_OUTPUT"

      - name: Build QR URL and PNG
        id: qr
        if: steps.gate.outputs.should_deploy == 'true'
        run: |
          SCHEME='${{ steps.deploy.outputs.scheme }}'
          ENCODED=$(node -e "console.log(encodeURIComponent(process.argv[1]))" "$SCHEME")
          QR_URL="https://quickchart.io/qr?size=420&text=${ENCODED}"
          echo "qr_url=$QR_URL" >> "$GITHUB_OUTPUT"
          curl -fsSL "$QR_URL" -o takealook-deploy-qr.png

      - name: Notify Discord (success)
        if: steps.gate.outputs.should_deploy == 'true' && success()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -z "$DISCORD_WEBHOOK_URL" ]; then
            exit 0
          fi

          PAYLOAD=$(jq -n \
            --arg scheme '${{ steps.deploy.outputs.scheme }}' \
            --arg qr '${{ steps.qr.outputs.qr_url }}' \
            --arg runUrl 'https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}' \
            '{
              username: "떼껄룩봇",
              content: "✅ **Web FE AIT 배포 완료**",
              embeds: [
                {
                  color: 3447003,
                  title: "takealook-webview (src/main)",
                  description: "React Web FE 기준 AIT 배포",
                  fields: [
                    { name: "Scheme", value: ("`" + $scheme + "`") },
                    { name: "QR", value: ("[열기](" + $qr + ")") },
                    { name: "Run", value: ("[GitHub Actions](" + $runUrl + ")") }
                  ],
                  image: { url: $qr },
                  footer: { text: "takealook-webview / Web FE" }
                }
              ]
            }')

          curl -sS -X POST "$DISCORD_WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d "$PAYLOAD"

      - name: Notify Discord (failure)
        if: failure()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -z "$DISCORD_WEBHOOK_URL" ]; then
            exit 0
          fi
          MSG="❌ Web FE AIT 배포 실패\n- run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          export MSG
          PAYLOAD=$(python3 -c 'import json, os; print(json.dumps({"username":"떼껄룩봇","content":os.environ["MSG"]}, ensure_ascii=False))')
          curl -sS -X POST "$DISCORD_WEBHOOK_URL" -H 'Content-Type: application/json' -d "$PAYLOAD"
