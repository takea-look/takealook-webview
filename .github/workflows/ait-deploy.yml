name: Flutter AIT Build & Deploy

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: flutter-ait-deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-deploy-ait:
    runs-on: ubuntu-latest
    timeout-minutes: 40

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Flutter pub get
        working-directory: flutter
        run: flutter pub get

      - name: Flutter analyze
        working-directory: flutter
        run: flutter analyze

      - name: Flutter test
        working-directory: flutter
        run: flutter test

      - name: Build Flutter web release
        working-directory: flutter
        run: flutter build web --release

      - name: Sync Flutter web bundle to Vite public
        run: |
          rm -rf public/flutter
          mkdir -p public/flutter
          cp -R flutter/build/web/. public/flutter/

      - name: Install web dependencies
        run: npm ci

      - name: Build AIT bundle (Vite + ait)
        env:
          VITE_DEBUG_AUTH_FLOW: "true"
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: takealook-artifacts
          path: |
            takealook.ait
            flutter/build/web

      - name: Deploy to Apps in Toss
        id: deploy
        env:
          TOSS_KEY: ${{ secrets.TOSS_KEY }}
        run: |
          set -eo pipefail
          if [ -z "$TOSS_KEY" ]; then
            echo "TOSS_KEY secret is not set"
            exit 1
          fi

          npx ait deploy --api-key "$TOSS_KEY" | tee deploy.log

          SCHEME=$(grep -Eo 'intoss-private://[^[:space:]]+' deploy.log | tail -n 1 | sed -E 's/\x1B\[[0-9;]*[mK]//g' || true)
          if [ -z "$SCHEME" ]; then
            echo "Failed to extract intoss-private scheme from deploy output"
            cat deploy.log
            exit 1
          fi

          echo "scheme=$SCHEME" >> "$GITHUB_OUTPUT"

      - name: Build QR URL and PNG
        id: qr
        run: |
          SCHEME='${{ steps.deploy.outputs.scheme }}'
          ENCODED=$(node -e "console.log(encodeURIComponent(process.argv[1]))" "$SCHEME")
          QR_URL="https://quickchart.io/qr?size=420&text=${ENCODED}"
          echo "qr_url=$QR_URL" >> "$GITHUB_OUTPUT"
          curl -fsSL "$QR_URL" -o takealook-deploy-qr.png

      - name: Upload QR artifact
        uses: actions/upload-artifact@v4
        with:
          name: takealook-deploy-qr
          path: takealook-deploy-qr.png

      - name: Write workflow summary
        run: |
          {
            echo "## ✅ Flutter 기반 AIT 배포 완료"
            echo ""
            echo "- Flutter analyze/test/web build: passed"
            echo "- AIT bundle: `takealook.ait`"
            echo "- Scheme: `${{ steps.deploy.outputs.scheme }}`"
            echo "- QR URL: ${{ steps.qr.outputs.qr_url }}"
            echo ""
            echo "![Deploy QR](${{ steps.qr.outputs.qr_url }})"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Notify Discord channel (optional)
        if: ${{ secrets.DISCORD_WEBHOOK_URL != '' }}
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          PAYLOAD=$(jq -n \
            --arg scheme '${{ steps.deploy.outputs.scheme }}' \
            --arg qr '${{ steps.qr.outputs.qr_url }}' \
            '{
              username: "떼껄룩봇",
              content: ("✅ **Flutter AIT 배포 완료**\n`" + $scheme + "`") ,
              embeds: [
                {
                  color: 5763719,
                  title: "takealook-webview Flutter AIT",
                  description: "Flutter web 빌드 + AIT 번들 + 배포 완료",
                  fields: [
                    { name: "Scheme", value: ("`" + $scheme + "`") },
                    { name: "Open via QR", value: ("[QR 열기](" + $qr + ")") }
                  ],
                  image: { url: $qr },
                  footer: { text: "GitHub Actions" }
                }
              ]
            }')

          curl -sS -X POST "$DISCORD_WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d "$PAYLOAD"
